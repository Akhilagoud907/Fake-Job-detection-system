
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Fake Job Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; }
        #retrain-container { margin: 20px 0; }
        #retrainProgress { width: 0%; height: 20px; background-color: #4BC0C0; }
    </style>
</head>
<body>

<h1>Admin Dashboard</h1>
<button id="logoutBtn">Logout</button>
<button id="exportBtn">Export Predictions</button>
<button id="retrainBtn">Retrain Model</button>

<!-- Retraining Progress -->
<div id="retrain-container">
    <label for="retrainProgress">Retraining Progress:</label>
    <div style="width: 100%; background: #ddd; border-radius: 5px; overflow: hidden;">
        <div id="retrainProgress"></div>
    </div>
</div>

<!-- Charts -->
<canvas id="pieChart" width="400" height="200"></canvas>
<canvas id="lineChart" width="400" height="200"></canvas>

<!-- Flagged Posts Table -->
<table id="flaggedTable">
    <thead>
        <tr>
            <th>Job Text</th>
            <th>Reason</th>
            <th>Comments</th>
            <th>Timestamp</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
const token = localStorage.getItem("token");
if (!token) {
    alert("Session expired. Please login again.");
    window.location.href = "admin_login.html";
}

// Logout
document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("token");
    window.location.href = "admin_login.html";
});

// Load Flagged Posts
async function loadFlaggedPosts() {
    try {
        const res = await fetch("http://127.0.0.1:8000/admin/flagged", {
            headers: { "Authorization": "Bearer " + token }
        });
        if (!res.ok) throw new Error("Failed to fetch flagged posts");

        const data = await res.json();
        const posts = data.flagged_posts || data; // fallback if backend returns list directly
        const tbody = document.querySelector("#flaggedTable tbody");
        tbody.innerHTML = '';
        if (Array.isArray(posts)) {
            posts.forEach(p => {
                const row = `<tr>
                    <td>${p.post_text}</td>
                    <td>${p.reason}</td>
                    <td>${p.comments || ""}</td>
                    <td>${p.created_at || p.timestamp}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }
    } catch (err) {
        console.error(err);
    }
}

// Load Charts
let pieChart, lineChart;
async function loadCharts() {
    try {
        const res = await fetch("http://127.0.0.1:8000/admin/stats", {
            headers: { "Authorization": "Bearer " + token }
        });
        if (!res.ok) return;
        const data = await res.json();

        const pieData = [data.fake || 0, data.real || 0];
        const ctxPie = document.getElementById("pieChart").getContext("2d");
        if (!pieChart) {
            pieChart = new Chart(ctxPie, {
                type: "pie",
                data: { labels: ["Fake", "Real"], datasets: [{ data: pieData, backgroundColor: ["#FF6384","#36A2EB"] }] }
            });
        } else {
            pieChart.data.datasets[0].data = pieData;
            pieChart.update();
        }

        const ctxLine = document.getElementById("lineChart").getContext("2d");
        const labels = data.trend?.labels || [];
        const counts = data.trend?.counts || [];
        if (!lineChart) {
            lineChart = new Chart(ctxLine, {
                type: "line",
                data: { labels, datasets: [{ label: "Total Predictions", data: counts, borderColor: "#4BC0C0", fill: false }] }
            });
        } else {
            lineChart.data.labels = labels;
            lineChart.data.datasets[0].data = counts;
            lineChart.update();
        }

    } catch (err) {
        console.error(err);
    }
}

// Export Predictions
document.getElementById("exportBtn").addEventListener("click", async () => {
    try {
        const res = await fetch("http://127.0.0.1:8000/predictions/export", {
            headers: { "Authorization": "Bearer " + token }
        });

        if (!res.ok) {
            const err = await res.json();
            return alert("Export failed: " + (err.detail || res.statusText));
        }

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `predictions_${Date.now()}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    } catch (err) {
        alert("Export failed: " + err.message);
    }
});

// Retrain Model
document.getElementById("retrainBtn").addEventListener("click", async () => {
    if (!confirm("Are you sure you want to retrain the model?")) return;
    const res = await fetch("http://127.0.0.1:8000/retrain/", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) return alert("Retraining failed");
    const data = await res.json();
    alert(`Retraining started. Task ID: ${data.task_id}`);
});

// Initialize
loadFlaggedPosts();
loadCharts();
setInterval(() => {
    loadFlaggedPosts();
    loadCharts();
}, 10000);
</script>

</body>
</html>





